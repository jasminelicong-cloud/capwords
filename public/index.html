<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CapWords - AI è¯­è¨€å­¦ä¹ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #FFE5EC 0%, #FFF0F5 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            color: #FF6B9D;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats {
            display: flex;
            gap: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #FF6B9D;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* ç›¸æœºæŒ‰é’® */
        .camera-section {
            text-align: center;
            margin: 50px 0;
        }

        .camera-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B9D, #C44569);
            border: none;
            font-size: 48px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(255, 107, 157, 0.4);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .camera-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 40px rgba(255, 107, 157, 0.6);
        }

        .camera-btn:active {
            transform: scale(0.95);
        }

        .camera-hint {
            margin-top: 20px;
            font-size: 16px;
            color: #666;
        }

        #fileInput {
            display: none;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #FFE5EC;
            border-top-color: #FF6B9D;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-words {
            margin-top: 20px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.5em;
            color: #FF6B9D;
            font-weight: 600;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .word-item {
            animation: wordFade 0.8s ease-in-out;
        }

        @keyframes wordFade {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            50% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* å¡ç‰‡ç½‘æ ¼ */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        /* æ‰«æåŠ¨ç”» */
        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .scan-effect {
            position: relative;
            overflow: hidden;
        }

        .scan-effect::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 0%,
                rgba(255, 107, 157, 0.3) 50%,
                transparent 100%
            );
            animation: scan 2s ease-in-out;
            pointer-events: none;
        }

        .card-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .card-content {
            padding: 25px;
        }

        .card-text {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.4em;
            color: #000;
            line-height: 1.6;
            margin-bottom: 18px;
            animation: fadeIn 0.6s ease-out;
        }

        .card-sentence {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1em;
            color: #666;
            line-height: 1.7;
            animation: fadeIn 0.8s ease-out;
            margin-bottom: 20px;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .action-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .action-btn:hover {
            transform: scale(1.2);
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .empty-text {
            font-size: 20px;
            margin-bottom: 10px;
        }

        /* é€šçŸ¥ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¯¼èˆªæ  -->
        <div class="navbar">
            <div class="logo">
                ğŸ“š CapWords
            </div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">å­¦ä¹ è¯æ±‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="todayCount">0</div>
                    <div class="stat-label">ä»Šæ—¥æ–°å¢</div>
                </div>
            </div>
        </div>

        <!-- ç›¸æœºæŒ‰é’® -->
        <div class="camera-section">
            <button class="camera-btn" id="cameraBtn">ğŸ“·</button>
            <p class="camera-hint">ç‚¹å‡»æ‹ç…§ï¼Œå¼€å§‹å­¦ä¹ </p>
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <!-- åŠ è½½åŠ¨ç”» -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>å¡ç‰‡ç”Ÿæˆä¸­â€¦â€¦ç­‰å¾…æ—¶é—´ï¼Œæˆ‘ä»¬æ¥èƒŒèƒŒå•è¯å‘€ï¼</p>
            <div class="loading-words" id="loadingWords"></div>
        </div>

        <!-- å¡ç‰‡ç½‘æ ¼ -->
        <div class="cards-grid" id="cardsGrid"></div>

        <!-- ç©ºçŠ¶æ€ -->
        <div class="empty-state" id="emptyState">
            <div class="empty-icon">ğŸ¨</div>
            <p class="empty-text">è¿˜æ²¡æœ‰å­¦ä¹ å¡ç‰‡</p>
            <p class="camera-hint">ç‚¹å‡»ä¸Šæ–¹ç›¸æœºæŒ‰é’®ï¼Œæ‹æ‘„ç‰©å“å¼€å§‹å­¦ä¹ å§ï¼</p>
        </div>
    </div>

    <script>
        // é…ç½®
        const BACKEND_URL = '/api';
        
        // æ•°æ®å­˜å‚¨
        let cards = [];
        let todayCount = 0;

        // DOM å…ƒç´ 
        const cameraBtn = document.getElementById('cameraBtn');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const loadingWords = document.getElementById('loadingWords');
        const cardsGrid = document.getElementById('cardsGrid');
        const emptyState = document.getElementById('emptyState');
        const totalCountEl = document.getElementById('totalCount');
        const todayCountEl = document.getElementById('todayCount');

        // å•è¯æ±  - å¸¸è§è‹±æ–‡å•è¯
        const wordPool = [
            'apple', 'banana', 'cat', 'dog', 'elephant', 'flower', 'guitar', 'house',
            'island', 'jacket', 'kite', 'lemon', 'mountain', 'notebook', 'ocean', 'piano',
            'queen', 'rainbow', 'sunset', 'tree', 'umbrella', 'violin', 'waterfall', 'xylophone',
            'yacht', 'zebra', 'adventure', 'beautiful', 'creative', 'delicious', 'elegant', 'fantastic',
            'gorgeous', 'harmony', 'inspire', 'journey', 'knowledge', 'liberty', 'miracle', 'nature',
            'opportunity', 'passion', 'quality', 'respect', 'serenity', 'treasure', 'unique', 'victory',
            'wisdom', 'excellence', 'butterfly', 'chocolate', 'diamond', 'energy', 'freedom', 'happiness'
        ];

        let wordInterval = null;

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            loadCards();
            updateStats();
            
            // ç»‘å®šäº‹ä»¶
            cameraBtn.addEventListener('click', () => {
                console.log('ğŸ“· ç›¸æœºæŒ‰é’®è¢«ç‚¹å‡»');
                fileInput.click();
            });
            
            fileInput.addEventListener('change', handleImageUpload);
            
            console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });

        // åŠ è½½å¡ç‰‡
        function loadCards() {
            const saved = localStorage.getItem('capwords_cards');
            if (saved) {
                cards = JSON.parse(saved);
                renderCards();
            }
            
            const today = new Date().toDateString();
            const savedToday = localStorage.getItem('capwords_today');
            if (savedToday === today) {
                todayCount = parseInt(localStorage.getItem('capwords_today_count') || '0');
            } else {
                todayCount = 0;
                localStorage.setItem('capwords_today', today);
                localStorage.setItem('capwords_today_count', '0');
            }
        }

        // ä¿å­˜å¡ç‰‡
        function saveCards() {
            localStorage.setItem('capwords_cards', JSON.stringify(cards));
            localStorage.setItem('capwords_today_count', todayCount.toString());
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            totalCountEl.textContent = cards.length;
            todayCountEl.textContent = todayCount;
        }

        // æ¸²æŸ“å¡ç‰‡
        function renderCards() {
            if (cards.length === 0) {
                emptyState.style.display = 'block';
                cardsGrid.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                cardsGrid.style.display = 'grid';
                
                cardsGrid.innerHTML = '';
                cards.forEach((card, index) => {
                    const cardEl = createCardElement(card, index);
                    cardsGrid.appendChild(cardEl);
                });
            }
        }

        // åˆ›å»ºå¡ç‰‡å…ƒç´ 
        function createCardElement(card, index) {
            const div = document.createElement('div');
            div.className = 'card';
            
            const english = card.english || '';
            const japanese = card.japanese || '';
            const sentence = card.sentence || '';
            const imageUrl = card.imageUrl || '';
            
            div.innerHTML = `
                ${imageUrl ? `
                    <div class="scan-effect">
                        <img src="${imageUrl}" alt="${english}" class="card-image">
                    </div>
                ` : ''}
                
                <div class="card-content">
                    ${english ? `<div class="card-text">${english}</div>` : ''}
                    ${japanese ? `<div class="card-text">${japanese}</div>` : ''}
                    ${sentence ? `<div class="card-sentence">${sentence}</div>` : ''}
                    
                    <div class="card-actions">
                        <button class="action-btn" onclick="playPronunciation('${english}')" title="å‘éŸ³">ğŸ”Š</button>
                        <button class="action-btn" onclick="deleteCard(${index})" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `;
            
            return div;
        }

        // å¼€å§‹å•è¯æ»šåŠ¨åŠ¨ç”»
        function startWordAnimation() {
            let usedWords = [];
            
            function showNextWord() {
                // å¦‚æœæ‰€æœ‰å•è¯éƒ½ç”¨è¿‡äº†ï¼Œé‡ç½®
                if (usedWords.length >= wordPool.length) {
                    usedWords = [];
                }
                
                // è·å–æœªä½¿ç”¨çš„å•è¯
                const availableWords = wordPool.filter(w => !usedWords.includes(w));
                const randomWord = availableWords[Math.floor(Math.random() * availableWords.length)];
                usedWords.push(randomWord);
                
                // æ˜¾ç¤ºå•è¯
                loadingWords.innerHTML = `<span class="word-item">${randomWord}</span>`;
            }
            
            // ç«‹å³æ˜¾ç¤ºç¬¬ä¸€ä¸ªå•è¯
            showNextWord();
            
            // æ¯1500msåˆ‡æ¢ä¸€ä¸ªæ–°å•è¯ï¼ˆè°ƒæ…¢é€Ÿåº¦ï¼‰
            wordInterval = setInterval(showNextWord, 1500);
        }

        // åœæ­¢å•è¯æ»šåŠ¨åŠ¨ç”»
        function stopWordAnimation() {
            if (wordInterval) {
                clearInterval(wordInterval);
                wordInterval = null;
            }
            loadingWords.innerHTML = '';
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('ğŸ“ é€‰æ‹©çš„æ–‡ä»¶:', file.name);
            
            loading.style.display = 'block';
            emptyState.style.display = 'none';
            startWordAnimation();
            
            try {
                // 1. ä¸Šä¼ å›¾ç‰‡
                const formData = new FormData();
                formData.append('file', file);
                
                const uploadResponse = await fetch(`${BACKEND_URL}/api/upload-image`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    throw new Error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥');
                }
                
                const uploadResult = await uploadResponse.json();
                const imageUrl = uploadResult.url;
                console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', imageUrl);
                
                // 2. è°ƒç”¨ AI è¯†åˆ«
                const requestData = {
                    image_url: imageUrl,
                    query: 'è¯·è¯†åˆ«è¿™å¼ å›¾ç‰‡ä¸­çš„ç‰©ä½“ï¼Œå¹¶æä¾›è‹±æ–‡åç§°ã€æ—¥è¯­ç¿»è¯‘å’Œä¾‹å¥ã€‚'
                };
                
                const sseResponse = await fetch(`${BACKEND_URL}/api/chat/sse`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!sseResponse.ok) {
                    throw new Error('AI è¯†åˆ«å¤±è´¥');
                }
                
                // 3. å¤„ç† SSE å“åº”
                const result = await handleSSEResponse(sseResponse);
                console.log('âœ… SSE å“åº”:', result);
                
                // 4. è§£æå¹¶æ·»åŠ å¡ç‰‡
                const cardData = parseAIResponse(result, imageUrl);
                if (cardData) {
                    cards.unshift(cardData);
                    todayCount++;
                    saveCards();
                    updateStats();
                    renderCards();
                    showNotification('âœ… å­¦ä¹ å¡ç‰‡å·²ç”Ÿæˆï¼');
                } else {
                    throw new Error('æ— æ³•è§£æ AI å“åº”');
                }
                
            } catch (error) {
                console.error('âŒ é”™è¯¯:', error);
                showNotification('âŒ ' + error.message);
            } finally {
                stopWordAnimation();
                loading.style.display = 'none';
                fileInput.value = '';
            }
        }

        // å¤„ç† SSE å“åº”
        async function handleSSEResponse(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let finalContent = '';
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';
                
                for (const line of lines) {
                    if (!line.startsWith('data: ')) continue;
                    
                    try {
                        const eventData = JSON.parse(line.substring(6));
                        
                        if (eventData.type === 'reply') {
                            const payload = eventData.payload;
                            const actualPayload = payload.payload || payload;
                            
                            if (actualPayload.is_from_self) continue;
                            
                            if (actualPayload.content) {
                                finalContent = actualPayload.content;
                            }
                            
                            if (actualPayload.is_final) break;
                        }
                    } catch (e) {
                        console.warn('è§£æ SSE æ•°æ®å¤±è´¥:', e);
                    }
                }
            }
            
            return { content: finalContent };
        }

        // è§£æ AI å“åº”
        function parseAIResponse(result, imageUrl) {
            try {
                let jsonStr = result.content || '';
                
                // ç§»é™¤ Markdown ä»£ç å—
                if (jsonStr.startsWith('```')) {
                    jsonStr = jsonStr.replace(/^```(?:json)?\s*\n?/, '');
                    jsonStr = jsonStr.replace(/\n?```\s*$/, '');
                }
                
                jsonStr = jsonStr.trim();
                
                const data = JSON.parse(jsonStr);
                console.log('âœ… JSON è§£ææˆåŠŸ:', data);
                
                if (!data.data?.primary_object) {
                    throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
                
                const obj = data.data.primary_object;
                
                return {
                    id: Date.now(),
                    english: obj.object || '',
                    japanese: obj.translations?.ja || '',
                    sentence: obj.example_sentence || '',
                    imageUrl: imageUrl,
                    createdAt: new Date().toISOString()
                };
                
            } catch (error) {
                console.error('âŒ è§£æå¤±è´¥:', error);
                return null;
            }
        }

        // åˆ é™¤å¡ç‰‡
        function deleteCard(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å¡ç‰‡å—ï¼Ÿ')) {
                cards.splice(index, 1);
                saveCards();
                updateStats();
                renderCards();
                showNotification('âœ… å¡ç‰‡å·²åˆ é™¤');
            }
        }

        // æ’­æ”¾å‘éŸ³
        function playPronunciation(text) {
            if (!text) return;
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
